<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offload Timeline Viewer</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    padding: 20px;
    background: #f3f4f6;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

h1 {
    margin-bottom: 20px;
    color: #1f2937;
}

.auth-container {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
}

.auth-container h3 {
    margin-bottom: 8px;
    color: #92400e;
}

.auth-form {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.auth-form input {
    padding: 8px 12px;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.auth-form button {
    background: #2563eb;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
}

.auth-form button:hover {
    background: #1d4ed8;
}

.user-info {
    color: #78350f;
    font-weight: 600;
}

.instructions {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    display: none;
}

.instructions h3 {
    margin-bottom: 8px;
    color: #1e40af;
}

.instructions p {
    color: #1e3a8a;
    line-height: 1.5;
}

textarea {
    width: 100%;
    height: 150px;
    padding: 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    margin-bottom: 12px;
    resize: vertical;
}

button {
    background: #2563eb;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 20px;
}

button:hover {
    background: #1d4ed8;
}

#timeline {
    overflow-x: auto;
    overflow-y: hidden;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    background: #fafafa;
    white-space: nowrap;
    display: none;
}

.timeline-wrapper {
    display: inline-block;
    white-space: nowrap;
}

.month-group {
    display: inline-block;
    vertical-align: top;
    border-right: 2px solid #9ca3af;
    padding-right: 8px;
    margin-right: 8px;
}

.month-group:last-child {
    border-right: none;
}

.month-header {
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    color: #1f2937;
    padding: 2px 4px;
    margin-bottom: 2px;
}

.month-days {
    display: inline-flex;
}

.day-group {
    display: inline-block;
    vertical-align: top;
}

.day-header {
    text-align: center;
    font-size: 9px;
    font-weight: 600;
    color: #6b7280;
    padding: 1px 0;
    line-height: 1;
}

.day-entries {
    display: inline-flex;
}

.entry-viz {
    width: 10px;
    height: 274px;
    position: relative;
    background: white;
    display: inline-block;
    vertical-align: top;
    margin: 0px;
    cursor: pointer;
}

.entry-viz:hover {
    outline: 2px solid #000;
    z-index: 10;
}

.delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 3px;
    width: 16px;
    height: 16px;
    font-size: 10px;
    line-height: 1;
    cursor: pointer;
    display: none;
    z-index: 20;
    padding: 0;
}

.entry-viz:hover .delete-btn {
    display: block;
}

.delete-btn:hover {
    background: #b91c1c;
}

.tooltip {
    display: none;
    position: absolute;
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 20px;
    border-radius: 8px;
    font-size: 15px;
    width: calc(100% - 48px);
    max-width: none;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    pointer-events: none;
    top: 260px;
    left: 24px;
    right: 24px;
}

.tooltip.active {
    display: block;
}

.tooltip h4 {
    margin-bottom: 8px;
    color: #fbbf24;
    font-size: 18px;
}

.tooltip p {
    margin: 4px 0;
    font-size: 14px;
}

.tooltip-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 8px;
}

.tooltip-notes {
    grid-column: 1 / -1;
    margin-top: 8px;
    font-size: 13px;
    opacity: 0.9;
}

.app-content {
    display: none;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Offload Timeline Viewer</h1>
        
        <div id="authContainer" class="auth-container">
            <h3>Sign In</h3>
            <div id="authForm" class="auth-form">
                <input type="email" id="emailInput" placeholder="Email">
                <input type="password" id="passwordInput" placeholder="Password">
                <button onclick="signIn()">Sign In</button>
                <button onclick="signUp()" style="background: #059669;">Create Account</button>
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="signOut()" style="background: #dc2626; margin-left: 12px;">Sign Out</button>
            </div>
        </div>
        
        <div class="app-content" id="appContent">
            <div class="instructions">
                <h3>How to use:</h3>
                <p>1. In your Offload app, copy your CSV data<br>
                2. Paste the CSV data into the box below<br>
                3. Click "Generate Timeline" to visualize your data<br>
                4. Click "Save Dataset" to save it to the cloud<br>
                5. Use "Load Dataset" to load previously saved datasets<br>
                6. Hover over any slice to see details</p>
            </div>
            
            <div id="timeline"></div>
            
            <div id="mergeDialog" style="display: none; background: #f0f9ff; border: 2px solid #0891b2; border-radius: 8px; padding: 16px; margin-top: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 12px; color: #0891b2;">Import & Merge New Data</h3>
                <p style="margin-bottom: 12px; font-size: 14px;">Paste new CSV data below. It will be merged with your cloud dataset.</p>
                <textarea id="mergeInput" placeholder="Paste new CSV data here..." style="width: 100%; height: 120px; padding: 12px; border: 2px solid #0891b2; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; margin-bottom: 12px;"></textarea>
                <div style="display: flex; gap: 12px;">
                    <button onclick="performMerge()" style="background: #0891b2;">Merge & Upload</button>
                    <button onclick="closeMergeDialog()" style="background: #6b7280;">Cancel</button>
                </div>
                <div id="mergeStatus" style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 13px; font-family: 'Courier New', monospace; display: none; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <textarea id="dataInput" placeholder="Paste your CSV data here..."></textarea>
            
            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="generateTimeline()">Generate Timeline</button>
                <button onclick="deduplicateData()" style="background: #f59e0b;">üßπ Remove Duplicates</button>
                <button onclick="clearData()" style="background: #dc2626;">üóëÔ∏è Clear Data</button>
                <button onclick="showMergeDialog()" style="background: #0891b2;">üîÑ Import & Merge</button>
                <input type="text" id="datasetName" placeholder="Dataset name (e.g., 'Jan 2026 Data')" style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px;">
                <button onclick="saveDataset()" style="background: #059669;">üíæ Save Dataset</button>
                <button onclick="showLoadMenu()" style="background: #7c3aed;">üìÇ Load Dataset</button>
            </div>
            
            <div id="loadMenu" style="display: none; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 12px;">Saved Datasets:</h3>
                <div id="datasetList"></div>
            </div>
            
            <div id="debugPanel" style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                <h3 style="margin-bottom: 8px; color: #991b1b;">Debug Information</h3>
                <div id="debugLog" style="font-family: 'Courier New', monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
                <button onclick="document.getElementById('debugPanel').style.display='none'" style="margin-top: 8px; padding: 6px 12px; font-size: 14px; background: #6b7280;">Close</button>
            </div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyD0L71PHIIagURWY-odijmHAxzjvhpuVpY",
    authDomain: "offload---self-help-tools.firebaseapp.com",
    projectId: "offload---self-help-tools",
    storageBucket: "offload---self-help-tools.firebasestorage.app",
    messagingSenderId: "489192977136",
    appId: "1:489192977136:web:86f2cf0ab84e9a4e8e0835"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.auth = auth;
window.db = db;
window.firebaseAuth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, firebaseSignOut };
window.firestore = { collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs };

onAuthStateChanged(auth, (user) => {
    if (user) {
        document.getElementById('authForm').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('appContent').style.display = 'block';
        document.querySelector('.instructions').style.display = 'block';
    } else {
        document.getElementById('authForm').style.display = 'flex';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('appContent').style.display = 'none';
    }
});

window.signUp = async function() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    try {
        await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, email, password);
        alert('Account created successfully!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
};

window.signIn = async function() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    try {
        await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
    } catch (error) {
        alert('Error: ' + error.message);
    }
};

window.signOut = async function() {
    try {
        await window.firebaseAuth.firebaseSignOut(window.auth);
        document.getElementById('dataInput').value = '';
        document.getElementById('timeline').innerHTML = '';
    } catch (error) {
        alert('Error: ' + error.message);
    }
};

function showDebug(message) {
    const debugPanel = document.getElementById('debugPanel');
    const debugLog = document.getElementById('debugLog');
    debugPanel.style.display = 'block';
    debugLog.textContent += message + '\n';
}

// TIMESTAMP-BASED CSV PARSER - No more comma/quote issues!
function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const entries = [];
    let currentEntry = null;
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const timestampMatch = line.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)/);
        
        if (timestampMatch) {
            if (currentEntry) {
                entries.push(currentEntry);
            }
            
            const timestamp = timestampMatch[1];
            const restOfLine = line.substring(timestamp.length + 1);
            const parts = restOfLine.split(',');
            
            // Clean up notes - remove surrounding quotes and unescape double quotes
            let allNotes = parts.slice(6).join(',')
                .replace(/^"|"$/g, '')
                .replace(/""/g, '"')
                .trim();
            
            currentEntry = {
                Timestamp: timestamp,
                Topic: parts[0] || '',
                'Life Area': parts[1] || '',
                Hijacking: parts[2] || '',
                'Stressor %': parts[3] || '0',
                'Stabilizer %': parts[4] || '0',
                'Opportunity %': parts[5] || '0',
                allNotes: allNotes
            };
        } else if (currentEntry) {
            currentEntry.allNotes += '\n' + line;
        }
    }
    
    if (currentEntry) {
        entries.push(currentEntry);
    }
    
    return entries;
}

// Convert entries back to CSV format for saving
function entriesToCSV(entries) {
    let csv = 'Timestamp,Topic,Life Area,Hijacking,Stressor %,Stabilizer %,Opportunity %,Notes\n';
    entries.forEach(entry => {
        const notes = entry.allNotes.replace(/"/g, '""'); // Escape quotes
        csv += `${entry.Timestamp},${entry.Topic},${entry['Life Area']},${entry.Hijacking},${entry['Stressor %']},${entry['Stabilizer %']},${entry['Opportunity %']},"${notes}"\n`;
    });
    return csv;
}

window.saveDataset = async function() {
    const csvData = document.getElementById('dataInput').value;
    const name = document.getElementById('datasetName').value.trim();
    document.getElementById('debugLog').textContent = '';
    
    if (!csvData.trim()) {
        alert('Please paste CSV data first!');
        return;
    }
    if (!name) {
        alert('Please enter a name for this dataset!');
        return;
    }
    
    const user = window.auth.currentUser;
    if (!user) {
        alert('Please sign in first!');
        return;
    }
    
    try {
        showDebug('Starting save process...');
        const entries = parseCSV(csvData);
        showDebug(`Parsed ${entries.length} entries`);
        
        const datasetDocRef = window.firestore.doc(window.db, `users/${user.uid}/datasets/${name}`);
        await window.firestore.setDoc(datasetDocRef, {
            name: name,
            entries: entries,
            savedAt: new Date().toISOString()
        });
        showDebug('‚úÖ Save successful!');
        alert(`Dataset "${name}" saved to cloud!`);
        document.getElementById('datasetName').value = '';
    } catch (error) {
        showDebug('‚ùå ERROR: ' + error.message);
        alert('Error saving dataset: ' + error.message);
    }
};

window.showLoadMenu = async function() {
    const menu = document.getElementById('loadMenu');
    const list = document.getElementById('datasetList');
    const user = window.auth.currentUser;
    
    if (!user) {
        alert('Please sign in first!');
        return;
    }
    
    if (menu.style.display === 'none') {
        try {
            const datasetsRef = window.firestore.collection(window.db, `users/${user.uid}/datasets`);
            const querySnapshot = await window.firestore.getDocs(datasetsRef);
            
            if (querySnapshot.empty) {
                list.innerHTML = '<p style="color: #6b7280;">No saved datasets yet.</p>';
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                querySnapshot.forEach((doc) => {
                    const dataset = doc.data();
                    const date = new Date(dataset.savedAt).toLocaleString();
                    const escapedName = dataset.name.replace(/'/g, "\\'");
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div>
                                <strong>${dataset.name}</strong>
                                <div style="font-size: 12px; color: #6b7280;">Saved: ${date} | ${dataset.entries.length} entries</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadDataset('${escapedName}')" style="padding: 6px 12px; font-size: 14px; background: #2563eb;">Load</button>
                                <button onclick="deleteDataset('${escapedName}')" style="padding: 6px 12px; font-size: 14px; background: #dc2626;">Delete</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                list.innerHTML = html;
            }
            menu.style.display = 'block';
        } catch (error) {
            alert('Error loading datasets: ' + error.message);
        }
    } else {
        menu.style.display = 'none';
    }
};

window.loadDataset = async function(name) {
    const user = window.auth.currentUser;
    if (!user) {
        alert('Please sign in first!');
        return;
    }
    
    try {
        const datasetDocRef = window.firestore.doc(window.db, `users/${user.uid}/datasets/${name}`);
        const docSnap = await window.firestore.getDoc(datasetDocRef);
        
        if (docSnap.exists()) {
            const dataset = docSnap.data();
            const entries = dataset.entries;
            const csvOutput = entriesToCSV(entries);
            
            document.getElementById('dataInput').value = csvOutput;
            generateTimeline();
            document.getElementById('loadMenu').style.display = 'none';
            alert(`Dataset "${name}" loaded!`);
        } else {
            alert('Dataset not found!');
        }
    } catch (error) {
        alert('Error loading dataset: ' + error.message);
    }
};

window.deleteDataset = async function(name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
    
    const user = window.auth.currentUser;
    if (!user) {
        alert('Please sign in first!');
        return;
    }
    
    try {
        const datasetDocRef = window.firestore.doc(window.db, `users/${user.uid}/datasets/${name}`);
        await window.firestore.deleteDoc(datasetDocRef);
        showLoadMenu();
        showLoadMenu();
        alert(`Dataset "${name}" deleted!`);
    } catch (error) {
        alert('Error deleting dataset: ' + error.message);
    }
};

function normalizeTimestamp(timestamp) {
    const date = new Date(timestamp);
    date.setMilliseconds(0);
    return date.toISOString();
}

function removeDuplicates(entries) {
    const seen = new Map();
    const duplicates = [];
    const unique = [];
    
    entries.forEach((entry) => {
        const normalizedTimestamp = normalizeTimestamp(entry.Timestamp);
        const topic = (entry.Topic || '').trim();
        const lifeArea = (entry['Life Area'] || '').trim();
        const stressor = (entry['Stressor %'] || '').toString().trim();
        const stabilizer = (entry['Stabilizer %'] || '').toString().trim();
        const opportunity = (entry['Opportunity %'] || '').toString().trim();
        const duplicateKey = `${normalizedTimestamp}|${topic}|${lifeArea}|${stressor}|${stabilizer}|${opportunity}`;
        
        if (seen.has(duplicateKey)) {
            const originalIndex = seen.get(duplicateKey);
            const original = unique[originalIndex];
            
            const currentDataLength = (entry.allNotes || '').length;
            const originalDataLength = (original.allNotes || '').length;
            
            if (currentDataLength > originalDataLength) {
                duplicates.push({
                    timestamp: normalizedTimestamp,
                    topic: original.Topic || 'Unnamed',
                    kept: 'newer (more data)'
                });
                unique[originalIndex] = entry;
            } else {
                duplicates.push({
                    timestamp: normalizedTimestamp,
                    topic: entry.Topic || 'Unnamed',
                    kept: 'original (more data)'
                });
            }
        } else {
            seen.set(duplicateKey, unique.length);
            unique.push(entry);
        }
    });
    
    return { unique, duplicates };
}

window.deduplicateData = function() {
    const input = document.getElementById('dataInput').value;
    if (!input.trim()) {
        alert('Please paste CSV data first!');
        return;
    }
    
    try {
        const entries = parseCSV(input);
        const beforeCount = entries.length;
        const { unique, duplicates } = removeDuplicates(entries);
        const afterCount = unique.length;
        const removedCount = beforeCount - afterCount;
        
        if (removedCount === 0) {
            alert('No duplicates found! Your data is already clean.');
            return;
        }
        
        const csvOutput = entriesToCSV(unique);
        document.getElementById('dataInput').value = csvOutput;
        generateTimeline();
        
        let message = `‚ú® Deduplication Complete!\n\nBefore: ${beforeCount} entries\nAfter: ${afterCount} entries\nRemoved: ${removedCount} duplicate(s)\n\n`;
        if (duplicates.length > 0) {
            message += `Duplicates removed:\n`;
            duplicates.forEach(dup => {
                message += `‚Ä¢ ${dup.timestamp} - ${dup.topic} (${dup.kept})\n`;
            });
        }
        alert(message);
    } catch (error) {
        alert('Error deduplicating data: ' + error.message);
    }
};

function generateVisualizationHTML(stressorPercent, stabilizerPercent, opportunityPercent) {
    const height = 274;
    const minZoneHeight = 30;
    
    let stressHeight = (stressorPercent / 100) * height;
    let regulatedHeight = (stabilizerPercent / 100) * height;
    let opportunityHeight = (opportunityPercent / 100) * height;
    
    if (stressHeight + regulatedHeight + opportunityHeight > height) {
        const scale = height / (stressHeight + regulatedHeight + opportunityHeight);
        stressHeight *= scale;
        regulatedHeight *= scale;
        opportunityHeight *= scale;
    }
    
    const availableForStress = height - (minZoneHeight * 2);
    const availableForRegulated = height - minZoneHeight - Math.min(stressHeight, availableForStress);
    
    stressHeight = Math.min(stressHeight, availableForStress);
    regulatedHeight = Math.min(regulatedHeight, availableForRegulated);
    opportunityHeight = Math.max(height - stressHeight - regulatedHeight, minZoneHeight);
    
    stressHeight = Math.floor(stressHeight);
    regulatedHeight = Math.floor(regulatedHeight);
    opportunityHeight = height - stressHeight - regulatedHeight;
    
    const stressGradient = stressorPercent <= 40 
        ? 'linear-gradient(to bottom, #FFFF00 0%, #FFFF33 50%, #FFCC00 100%)'
        : stressorPercent <= 60
        ? 'linear-gradient(to bottom, #FFCC00 0%, #FF9900 50%, #FF6600 100%)'
        : 'linear-gradient(to bottom, #FF4500 0%, #DC143C 50%, #B22222 100%)';
    
    const regulatedGradient = 'linear-gradient(to bottom, #87CEEB 0%, #4682B4 50%, #1E90FF 100%)';
    
    const opportunityGradient = opportunityPercent <= 50
        ? 'linear-gradient(to top, #32CD32 0%, #3CB371 50%, #90EE90 100%)'
        : opportunityPercent <= 65
        ? 'linear-gradient(to top, #3CB371 0%, #7FFF00 50%, #ADFF2F 100%)'
        : 'linear-gradient(to top, #7FFF00 0%, #ADFF2F 50%, #FFFF00 100%)';
    
    return `
        <div style="position: absolute; top: 0; left: 0; right: 0; height: ${stressHeight}px; background: ${stressGradient}; border-radius: 8px 8px 0 0;"></div>
        <div style="position: absolute; top: ${stressHeight}px; left: 0; right: 0; height: ${regulatedHeight}px; background: ${regulatedGradient};"></div>
        <div style="position: absolute; top: ${stressHeight + regulatedHeight}px; left: 0; right: 0; height: ${opportunityHeight}px; background: ${opportunityGradient}; border-radius: 0 0 8px 8px;"></div>
    `;
}

let globalEntries = [];

window.generateTimeline = function() {
    const input = document.getElementById('dataInput').value;
    const timeline = document.getElementById('timeline');
    
    if (!input.trim()) {
        timeline.style.display = 'none';
        return;
    }
    
    try {
        let entries = parseCSV(input);
        const { unique, duplicates } = removeDuplicates(entries);
        entries = unique;
        
        if (duplicates.length > 0) {
            console.log(`Auto-removed ${duplicates.length} duplicate(s)`);
        }
        
        entries.reverse();
        globalEntries = entries;
        
        const monthGroups = new Map();
        entries.forEach(entry => {
            const date = new Date(entry.Timestamp);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const dayKey = String(date.getDate());
            
            if (!monthGroups.has(monthKey)) {
                monthGroups.set(monthKey, {
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    days: new Map()
                });
            }
            
            const monthData = monthGroups.get(monthKey);
            if (!monthData.days.has(dayKey)) {
                monthData.days.set(dayKey, []);
            }
            monthData.days.get(dayKey).push(entry);
        });
        
        let html = '<div class="timeline-wrapper">';
        
        monthGroups.forEach((monthData) => {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[monthData.month];
            
            html += `<div class="month-group">`;
            html += `<div class="month-header">${monthName}</div>`;
            html += `<div class="month-days">`;
            
            const sortedDays = Array.from(monthData.days.keys()).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedDays.forEach(dayKey => {
                const dayEntries = monthData.days.get(dayKey);
                html += `<div class="day-group">`;
                html += `<div class="day-header">${dayKey}</div>`;
                html += `<div class="day-entries">`;
                
                dayEntries.forEach((entry) => {
                    const globalIndex = entries.indexOf(entry);
                    const stressorPercent = parseFloat(entry['Stressor %']) || 0;
                    const stabilizerPercent = parseFloat(entry['Stabilizer %']) || 0;
                    const opportunityPercent = parseFloat(entry['Opportunity %']) || 0;
                    const vizHTML = generateVisualizationHTML(stressorPercent, stabilizerPercent, opportunityPercent);
                    
                    html += `
                        <div class="entry-viz" 
                             onmouseenter="showTooltip(event, ${globalIndex})"
                             onmouseleave="hideTooltip()"
                             data-index="${globalIndex}">
                            <button class="delete-btn" onclick="deleteEntry(event, ${globalIndex})" title="Delete this entry">√ó</button>
                            ${vizHTML}
                        </div>
                    `;
                });
                html += `</div></div>`;
            });
            html += `</div></div>`;
        });
        
        html += '</div>';
        timeline.innerHTML = html;
        timeline.style.display = 'block';
    } catch (error) {
        alert('Error parsing CSV: ' + error.message);
        console.error(error);
    }
};

window.showTooltip = function(event, index) {
    const tooltip = document.getElementById('tooltip');
    const entry = globalEntries[index];
    if (!entry) return;
    
    const date = new Date(entry.Timestamp).toLocaleString();
    const topic = entry.Topic || 'Entry';
    const lifeArea = entry['Life Area'] || 'None';
    
    let html = `
        <h4>${topic || 'Entry'}</h4>
        <div class="tooltip-grid">
            <p><strong>Date:</strong> ${date}</p>
            <p><strong>Life Area:</strong> ${lifeArea}</p>
            <p style="grid-column: 1;"><strong>Stressors:</strong> ${entry['Stressor %']}%</p>
            <p><strong>Stabilizers:</strong> ${entry['Stabilizer %']}%</p>
            <p><strong>Opportunity:</strong> ${entry['Opportunity %']}%</p>
        </div>
        <div class="tooltip-notes" style="margin-top: 12px; white-space: pre-wrap;">${entry.allNotes}</div>
    `;
    
    tooltip.innerHTML = html;
    tooltip.classList.add('active');
};

window.hideTooltip = function() {
    document.getElementById('tooltip').classList.remove('active');
};

window.clearData = function() {
    document.getElementById('dataInput').value = '';
    document.getElementById('timeline').innerHTML = '';
    document.getElementById('timeline').style.display = 'none';
};

window.deleteEntry = async function(event, index) {
    event.stopPropagation();
    if (!confirm('Delete this entry?')) return;
    
    try {
        const input = document.getElementById('dataInput').value;
        let entries = parseCSV(input);
        entries.reverse();
        const deletedEntry = entries[index];
        entries.splice(index, 1);
        entries.reverse();
        
        const csvOutput = entriesToCSV(entries);
        document.getElementById('dataInput').value = csvOutput;
        generateTimeline();
        console.log(`Deleted: ${deletedEntry.Timestamp} - ${deletedEntry.Topic || 'Entry'}`);
    } catch (error) {
        alert('Error deleting entry: ' + error.message);
    }
};

window.showMergeDialog = function() {
    const currentData = document.getElementById('dataInput').value.trim();
    if (!currentData) {
        alert('Please download your cloud data first!');
        return;
    }
    document.getElementById('mergeDialog').style.display = 'block';
    document.getElementById('mergeStatus').style.display = 'none';
    document.getElementById('mergeInput').value = '';
};

window.closeMergeDialog = function() {
    document.getElementById('mergeDialog').style.display = 'none';
    document.getElementById('mergeInput').value = '';
};

window.performMerge = async function() {
    const statusDiv = document.getElementById('mergeStatus');
    statusDiv.style.display = 'block';
    
    try {
        const currentData = document.getElementById('dataInput').value.trim();
        const newData = document.getElementById('mergeInput').value.trim();
        
        if (!newData) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">Error: No new data provided</span>';
            return;
        }
        
        const currentEntries = parseCSV(currentData);
        const newEntries = parseCSV(newData);
        
        let debugLog = [];
        debugLog.push(`üìä Current dataset: ${currentEntries.length} entries`);
        debugLog.push(`üìä New data: ${newEntries.length} entries`);
        debugLog.push('---');
        
        const existingKeys = new Map();
        currentEntries.forEach(entry => {
            const normalizedTimestamp = normalizeTimestamp(entry.Timestamp);
            const topic = (entry.Topic || '').trim();
            const lifeArea = (entry['Life Area'] || '').trim();
            const stressor = (entry['Stressor %'] || '').toString().trim();
            const stabilizer = (entry['Stabilizer %'] || '').toString().trim();
            const opportunity = (entry['Opportunity %'] || '').toString().trim();
            const duplicateKey = `${normalizedTimestamp}|${topic}|${lifeArea}|${stressor}|${stabilizer}|${opportunity}`;
            existingKeys.set(duplicateKey, entry);
        });
        
        const trulyNewEntries = [];
        const duplicates = [];
        
        newEntries.forEach(entry => {
            const normalizedTimestamp = normalizeTimestamp(entry.Timestamp);
            const topic = (entry.Topic || '').trim();
            const lifeArea = (entry['Life Area'] || '').trim();
            const stressor = (entry['Stressor %'] || '').toString().trim();
            const stabilizer = (entry['Stabilizer %'] || '').toString().trim();
            const opportunity = (entry['Opportunity %'] || '').toString().trim();
            const duplicateKey = `${normalizedTimestamp}|${topic}|${lifeArea}|${stressor}|${stabilizer}|${opportunity}`;
            
            if (existingKeys.has(duplicateKey)) {
                duplicates.push(duplicateKey);
                debugLog.push(`‚è≠Ô∏è  Skipped duplicate: ${entry.Timestamp} - ${entry.Topic || 'Unnamed'}`);
            } else {
                trulyNewEntries.push(entry);
                debugLog.push(`‚úÖ Added: ${entry.Timestamp} - ${entry.Topic || 'Unnamed'}`);
            }
        });
        
        let mergedEntries = [...currentEntries, ...trulyNewEntries];
        mergedEntries.sort((a, b) => {
            const dateA = new Date(a.Timestamp);
            const dateB = new Date(b.Timestamp);
            return dateB - dateA;
        });
        
        const beforeDedup = mergedEntries.length;
        const dedupResult = removeDuplicates(mergedEntries);
        mergedEntries = dedupResult.unique;
        const removedFromOriginal = beforeDedup - mergedEntries.length - duplicates.length;
        
        debugLog.push('---');
        debugLog.push(`<strong style="color: #059669;">‚ú® Merge Complete!</strong>`);
        debugLog.push(`Added: ${trulyNewEntries.length} new entries`);
        debugLog.push(`Skipped from import: ${duplicates.length} duplicates`);
        if (removedFromOriginal > 0) {
            debugLog.push(`Cleaned from original: ${removedFromOriginal} duplicates`);
        }
        debugLog.push(`Total: ${mergedEntries.length} entries`);
        
        const csvOutput = entriesToCSV(mergedEntries);
        document.getElementById('dataInput').value = csvOutput;
        statusDiv.innerHTML = debugLog.join('<br>');
        generateTimeline();
    } catch (error) {
        statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${error.message}</span>`;
        console.error(error);
    }
};


// ORGANIZED TOOLTIP - Split notes into 3 sections with colors
window.showTooltip = function(event, index) {
    const tooltip = document.getElementById('tooltip');
    const entry = globalEntries[index];
    if (!entry) return;
    
    const date = new Date(entry.Timestamp).toLocaleString();
    const topic = entry.Topic || 'Entry';
    const lifeArea = entry['Life Area'] || 'None';
    
    let html = `
        <h4>${topic || 'Entry'}</h4>
        <div class="tooltip-grid">
            <p><strong>Date:</strong> ${date}</p>
            <p><strong>Life Area:</strong> ${lifeArea}</p>
            <p style="grid-column: 1;"><strong>Stressors:</strong> ${entry['Stressor %']}%</p>
            <p><strong>Stabilizers:</strong> ${entry['Stabilizer %']}%</p>
            <p><strong>Opportunity:</strong> ${entry['Opportunity %']}%</p>
        </div>
    `;
    
    // Split notes by "," pattern
    const parts = entry.allNotes.split('","');
    
    // Clean each part
    const stressorNotes = parts[0] ? parts[0].replace(/^"|"$/g, '').replace(/""/g, '"').trim() : '';
    const stabilizerNotes = parts[1] ? parts[1].replace(/^"|"$/g, '').replace(/""/g, '"').trim() : '';
    const opportunityNotes = parts[2] ? parts[2].replace(/^"|"$/g, '').replace(/""/g, '"').trim() : '';
    
    // Display organized notes
    let notesHTML = '<div class="tooltip-notes" style="margin-top: 12px;">';
    
    if (stressorNotes) {
        notesHTML += `
            <div style="margin-bottom: 12px;">
                <strong style="color: #fbbf24; font-size: 15px;">üî¥ Stressor:</strong>
                <div style="margin-top: 4px; white-space: pre-wrap; color: #d1d5db;">${stressorNotes}</div>
            </div>
        `;
    }
    
    if (stabilizerNotes) {
        notesHTML += `
            <div style="margin-bottom: 12px;">
                <strong style="color: #60a5fa; font-size: 15px;">üîµ Stabilizer:</strong>
                <div style="margin-top: 4px; white-space: pre-wrap; color: #d1d5db;">${stabilizerNotes}</div>
            </div>
        `;
    }
    
    if (opportunityNotes) {
        notesHTML += `
            <div style="margin-bottom: 12px;">
                <strong style="color: #4ade80; font-size: 15px;">üü¢ Opportunity:</strong>
                <div style="margin-top: 4px; white-space: pre-wrap; color: #d1d5db;">${opportunityNotes}</div>
            </div>
        `;
    }
    
    notesHTML += '</div>';
    html += notesHTML;
    
    tooltip.innerHTML = html;
    tooltip.classList.add('active');
};

    </script>
</body>
</html>
